<ng-container *ngIf="isLoading; else tableContent">
  <div class="table-card table-card--loading">
    <div class="skeleton-row" *ngFor="let _ of [1,2,3,4,5,6]">
      <div class="skeleton skeleton--wide"></div>
    </div>
  </div>
</ng-container>

<ng-template #tableContent>
  <div class="table-card">
    <div class="table-meta" *ngIf="leads.length">
      <span class="result-range">{{ resultRangeLabel }}</span>

      <div class="meta-actions">
        <div class="density-switch" role="group" aria-label="Densidade da tabela">
          <button type="button" [class.active]="density === 'default'" (click)="onDensityChange('default')">
            Padrão
          </button>
          <button type="button" [class.active]="density === 'compact'" (click)="onDensityChange('compact')">
            Compacto
          </button>
        </div>

        <div class="page-size">
          <label for="page-size">Itens por página</label>
          <select id="page-size" [value]="pageSize" (change)="onPageSizeChange($any($event.target).value)">
            <option *ngFor="let size of pageSizeOptions" [value]="size">{{ size }}</option>
          </select>
        </div>
      </div>
    </div>

    <div class="table-wrapper" [class.compact]="density === 'compact'" *ngIf="paginatedProcesses.length; else emptyState">
      <table>
        <thead>
          <tr>
            <th scope="col" (click)="sortBy('nome')">
              Nome
              <mat-icon *ngIf="sortColumn === 'nome'">
                {{ sortDirection === 'asc' ? 'arrow_upward' : 'arrow_downward' }}
              </mat-icon>
            </th>
            <th scope="col" (click)="sortBy('numero_processo')">
              Número do processo
              <mat-icon *ngIf="sortColumn === 'numero_processo'">
                {{ sortDirection === 'asc' ? 'arrow_upward' : 'arrow_downward' }}
              </mat-icon>
            </th>
            <th scope="col" class="numeric" (click)="sortBy('cpf')">
              CPF/CNPJ
              <mat-icon *ngIf="sortColumn === 'cpf'">
                {{ sortDirection === 'asc' ? 'arrow_upward' : 'arrow_downward' }}
              </mat-icon>
            </th>
            <th scope="col" class="numeric" (click)="sortBy('telefone_1')">
              Telefone
              <mat-icon *ngIf="sortColumn === 'telefone_1'">
                {{ sortDirection === 'asc' ? 'arrow_upward' : 'arrow_downward' }}
              </mat-icon>
            </th>
            <th scope="col" (click)="sortBy('email')">
              E-mail
              <mat-icon *ngIf="sortColumn === 'email'">
                {{ sortDirection === 'asc' ? 'arrow_upward' : 'arrow_downward' }}
              </mat-icon>
            </th>
            <th scope="col" (click)="sortBy('banco')">
              Banco
              <mat-icon *ngIf="sortColumn === 'banco'">
                {{ sortDirection === 'asc' ? 'arrow_upward' : 'arrow_downward' }}
              </mat-icon>
            </th>
            <th scope="col">
              Status
            </th>
            <th scope="col" (click)="sortBy('owner')">
              Pertence a
              <mat-icon *ngIf="sortColumn === 'owner'">
                {{ sortDirection === 'asc' ? 'arrow_upward' : 'arrow_downward' }}
              </mat-icon>
            </th>
            <th scope="col" class="actions-head">
              Ações
            </th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let lead of paginatedProcesses" (click)="verDetalhes(lead.id)">
            <td>
              <span class="ellipsis name" [title]="formatName(lead.nome) || '-'">{{ formatName(lead.nome) || '-' }}</span>
            </td>
            <td>
              <span class="ellipsis mono process" [title]="lead.numero_processo || '-'">{{ lead.numero_processo || '-' }}</span>
            </td>
            <td class="numeric">
              <span class="ellipsis doc" [title]="formatDocument(lead.cpf) || '-'">{{ formatDocument(lead.cpf) || '-' }}</span>
            </td>
            <td class="numeric">
              <a
                class="ellipsis link phone"
                *ngIf="formatPhone(lead.telefone_1); else noPhone"
                [href]="telHref(lead.telefone_1)"
                [title]="formatPhone(lead.telefone_1)">
                {{ formatPhone(lead.telefone_1) }}
              </a>
              <ng-template #noPhone> - </ng-template>
            </td>
            <td>
              <a class="ellipsis link email" *ngIf="lead.email; else noEmail" [href]="mailHref(lead.email)" [title]="lead.email">
                {{ lead.email }}
              </a>
              <ng-template #noEmail> - </ng-template>
            </td>
            <td>
              <span class="ellipsis bank" [title]="lead.banco || '-'">{{ lead.banco || '-' }}</span>
            </td>
            <td class="status-cell">
              <button
                type="button"
                class="chip"
                [ngClass]="getStatusMeta(lead).chipClass"
                [matMenuTriggerFor]="statusMenu"
                [attr.aria-label]="'Status ' + getStatusLabel(lead)">
                {{ getStatusLabel(lead) }}
              </button>
              <mat-menu #statusMenu="matMenu">
                <button mat-menu-item *ngFor="let permission of permissions" (click)="updateStatus(permission, lead)">
                  {{ permission }}
                </button>
              </mat-menu>
            </td>
            <td class="owner-cell">
              <div class="owner-info">
                <ng-container *ngIf="lead.owner?.image && !imageLoadError[lead.id]; else defaultOwnerIcon">
                  <img
                    class="owner-avatar"
                    [src]="lead.owner?.image"
                    [alt]="lead.owner?.nome || 'Responsável'"
                    (error)="onImageError(lead.id)" />
                </ng-container>
                <span class="owner-name">
                  {{ lead.owner?.nome || resolveOwner(lead.pertence_a) }}
                </span>
                <ng-template #defaultOwnerIcon>
                  <mat-icon class="owner-default-icon" aria-hidden="true">account_circle</mat-icon>
                </ng-template>
              </div>
            </td>
            <td class="actions-cell" (click)="$event.stopPropagation()">
              <button mat-icon-button [matMenuTriggerFor]="rowMenu" [attr.aria-label]="'Mais ações para o processo ' + (lead.numero_processo || lead.nome)">
                <mat-icon>more_vert</mat-icon>
              </button>
              <mat-menu #rowMenu="matMenu">
                <button mat-menu-item (click)="verDetalhes(lead.id)">Abrir</button>
                <button mat-menu-item (click)="verDetalhes(lead.id)">Detalhes</button>
                <button mat-menu-item (click)="updateStatus('Processo Desativado', lead)">Arquivar</button>
              </mat-menu>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <ng-template #emptyState>
      <div class="empty-state">
        <mat-icon>inbox</mat-icon>
        <h3>Nenhum processo disponível</h3>
        <p>Assim que novos processos forem encontrados eles aparecerão aqui.</p>
      </div>
    </ng-template>

    <div class="alert alert--error" *ngIf="!isLoading && !allLeads.length">
      Nenhum processo disponível no momento.
    </div>

    <div class="pagination" *ngIf="leads.length && totalPages > 1">
      <button type="button" (click)="prevPage()" [disabled]="currentPage === 1">Anterior</button>
      <button
        type="button"
        *ngFor="let page of totalPagesArray"
        [class.active]="page === currentPage"
        (click)="changePage(page)">
        {{ page }}
      </button>
      <button type="button" (click)="nextPage()" [disabled]="currentPage === totalPages">Próximo</button>
    </div>
  </div>
</ng-template>
